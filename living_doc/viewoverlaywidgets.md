- `ViewOverlayWidgets` は `ViewPart` を継承し、`addWidget`/`setWidgetPosition`/`removeWidget` で DOM ノードを絶対位置に配置しつつ、右上・右下・中央スタックやページ座標 (固定オーバーフロー) に対応し、`getMinContentWidthInPx` で取得した幅を `ViewLayout` に渡してスクロール幅を確保しながら描画・再描画制御を行っている。[src/vs/editor/browser/viewParts/overlayWidgets/overlayWidgets.ts](src/vs/editor/browser/viewParts/overlayWidgets/overlayWidgets.ts#L34-L287)
- `View` 側では `_overlayWidgets` をインスタンス化して `_overflowGuardContainer` に追加し、`overflowWidgetsDomNode` が与えられていればその外部ノードにも `overflowingOverlayWidgetsDomNode` を挿入、`addOverlayWidget`/`layoutOverlayWidget`/`removeOverlayWidget` で画面描画スケジュールを起動している。[src/vs/editor/browser/view.ts](src/vs/editor/browser/view.ts#L230-L283) [src/vs/editor/browser/view.ts](src/vs/editor/browser/view.ts#L745-L766)
- `CodeEditorWidget` は `IEditorConstructionOptions` の `overflowWidgetsDomNode` で外部容器を受け取り (オプション項目) 、ビュー生成時に渡しながら `addOverlayWidget`/`layoutOverlayWidget`/`removeOverlayWidget` で `View` に委譲し、ビュー再作成時には保持したウィジェット情報を再登録している。[src/vs/editor/browser/config/editorConfiguration.ts](src/vs/editor/browser/config/editorConfiguration.ts#L15-L38) [src/vs/editor/browser/widget/codeEditor/codeEditorWidget.ts](src/vs/editor/browser/widget/codeEditor/codeEditorWidget.ts#L225-L281) [src/vs/editor/browser/widget/codeEditor/codeEditorWidget.ts](src/vs/editor/browser/widget/codeEditor/codeEditorWidget.ts#L1559-L1870) [src/vs/editor/browser/widget/codeEditor/codeEditorWidget.ts](src/vs/editor/browser/widget/codeEditor/codeEditorWidget.ts#L1940-L1970)
- `IOverlayWidget` は位置指定 (固定の preference や座標)、`allowEditorOverflow`、`getDomNode`/`getPosition` などを持ち、`ViewLayout` は `ViewOverlayWidgets` からの最小幅を `setOverlayWidgetsMinWidth` で受け取ってスクロール幅を更新することでレイアウトと連携している。[src/vs/editor/browser/editorBrowser.ts](src/vs/editor/browser/editorBrowser.ts#L258-L310) [src/vs/editor/common/viewLayout/viewLayout.ts](src/vs/editor/common/viewLayout/viewLayout.ts#L335-L345)
- 標準機能や拡張が `IOverlayWidget` を実装して `addOverlayWidget` を呼ぶ例は数多く、エディタ本体では find/findOptions/zone/stickyScroll/glyphHover/suggest、単体機能では iPad キーボード表示・Quick Input、Diff Editor ヘルパー、Observables 経由の `ObservableCodeEditor` など、ワークベンチではコードカバレッジ装飾・Merge Editor 固定ゾーン・Chat Editing・Prompt Coding Agent アクション・設定のキー割り当てウィジェットなどが該当する。[src/vs/editor/contrib/find/browser/findWidget.ts](src/vs/editor/contrib/find/browser/findWidget.ts#L254) [src/vs/editor/contrib/find/browser/findOptionsWidget.ts](src/vs/editor/contrib/find/browser/findOptionsWidget.ts#L97) [src/vs/editor/contrib/zoneWidget/browser/zoneWidget.ts](src/vs/editor/contrib/zoneWidget/browser/zoneWidget.ts#L440) [src/vs/editor/contrib/stickyScroll/browser/stickyScrollController.ts](src/vs/editor/contrib/stickyScroll/browser/stickyScrollController.ts#L461) [src/vs/editor/contrib/hover/browser/glyphHoverWidget.ts](src/vs/editor/contrib/hover/browser/glyphHoverWidget.ts#L60) [src/vs/editor/contrib/suggest/browser/suggestWidgetDetails.ts](src/vs/editor/contrib/suggest/browser/suggestWidgetDetails.ts#L353) [src/vs/editor/standalone/browser/iPadShowKeyboard/iPadShowKeyboard.ts](src/vs/editor/standalone/browser/iPadShowKeyboard/iPadShowKeyboard.ts#L77) [src/vs/editor/standalone/browser/quickInput/standaloneQuickInputService.ts](src/vs/editor/standalone/browser/quickInput/standaloneQuickInputService.ts#L201) [src/vs/editor/browser/widget/diffEditor/utils.ts](src/vs/editor/browser/widget/diffEditor/utils.ts#L280) [src/vs/workbench/contrib/testing/browser/codeCoverageDecorations.ts](src/vs/workbench/contrib/testing/browser/codeCoverageDecorations.ts#L784) [src/vs/workbench/contrib/mergeEditor/browser/view/fixedZoneWidget.ts](src/vs/workbench/contrib/mergeEditor/browser/view/fixedZoneWidget.ts#L50) [src/vs/workbench/contrib/chat/browser/chatEditing/chatEditingCodeEditorIntegration.ts](src/vs/workbench/contrib/chat/browser/chatEditing/chatEditingCodeEditorIntegration.ts#L226-L801) [src/vs/workbench/contrib/chat/browser/promptSyntax/promptCodingAgentActionOverlay.ts](src/vs/workbench/contrib/chat/browser/promptSyntax/promptCodingAgentActionOverlay.ts#L94) [src/vs/workbench/contrib/preferences/browser/keybindingWidgets.ts](src/vs/workbench/contrib/preferences/browser/keybindingWidgets.ts#L307)

次のステップ:
1. `overflowWidgetsDomNode` を渡しているホスト（例えば Diff/Chat エディタや Quick Input）で実際に DOM を調べ、`overflowingOverlayWidgetsDomNode` が外部コンテナに移動しているかを DevTools で確認する。
2. オーバーレイのレンダリングロジックを変更する場合は、`View`/`CodeEditorWidget` を利用する各拡張（find、zone、stickyScroll、chat など）を操作して表示とフォーカス挙動に regressions がないか確認する。

## widget.preference が null になるのはいつか

- `addWidget` で `preference: null` で登録され、`setWidgetPosition` は `position` が null か `position.preference` が null のままなら `widget.preference` も何もせず null を維持するようになっているため、オーバーレイを追加した直後や `getPosition()` が null を返す限り null のままです（[src/vs/editor/browser/viewParts/overlayWidgets/overlayWidgets.ts](src/vs/editor/browser/viewParts/overlayWidgets/overlayWidgets.ts#L105-L142)）。`IOverlayWidget.getPosition()` の doc でも「null を返すのはウィジェット自身が位置決めを担う」ことを意味しており、null が特別扱いされているのがわかります（[src/vs/editor/browser/editorBrowser.ts](src/vs/editor/browser/editorBrowser.ts#L272-L313)）。
- `getPosition()` が null を返す具体例としては、非表示時・独自配置時の `FindWidget` や `PromptCodingAgentActionOverlayWidget`、`ZoneWidget` が返す `OverlayWidgetDelegate`、常に自前の `_showAt` で座標をセットする `GlyphHoverWidget` などがあり、いずれも `widget.preference` を null にしたまま DOM の CSS で位置を制御しています。`ViewOverlayWidgets._renderWidget` は `preference === null` の場合に `top` を空文字にして処理を打ち切るので、null は単にビューパートに任せないという指示になっています（[src/vs/editor/contrib/find/browser/findWidget.ts](src/vs/editor/contrib/find/browser/findWidget.ts#L290-L296)、[src/vs/workbench/contrib/chat/browser/promptSyntax/promptCodingAgentActionOverlay.ts](src/vs/workbench/contrib/chat/browser/promptSyntax/promptCodingAgentActionOverlay.ts#L74-L82)、[src/vs/editor/contrib/zoneWidget/browser/zoneWidget.ts](src/vs/editor/contrib/zoneWidget/browser/zoneWidget.ts#L102-L112)、[src/vs/editor/contrib/hover/browser/glyphHoverWidget.ts](src/vs/editor/contrib/hover/browser/glyphHoverWidget.ts#L77-L79)、[src/vs/editor/browser/viewParts/overlayWidgets/overlayWidgets.ts](src/vs/editor/browser/viewParts/overlayWidgets/overlayWidgets.ts#L175-L178)）。
- `DefineKeybindingOverlayWidget` は `getPosition()` が `position` オブジェクトを返すものの、`preference: null` を返して「エディタ側には座標も優先位置も渡さず自分で配置する」と明示しているので、こちらも `widget.preference` が null のままです（[src/vs/workbench/contrib/preferences/browser/keybindingWidgets.ts](src/vs/workbench/contrib/preferences/browser/keybindingWidgets.ts#L314-L322)）。
- `SuggestWidgetDetails` や Chat 編集の diff オーバーレイのように、必要な座標（`_topLeft` や `_position`）がまだ計算されていない段階では `getPosition()` が null を返していて、計算後に `_applyTopLeft`／`layout()` から `layoutOverlayWidget` を呼び出すことで初めて `widget.preference` に値が入り、描画される仕組みです（[src/vs/editor/contrib/suggest/browser/suggestWidgetDetails.ts](src/vs/editor/contrib/suggest/browser/suggestWidgetDetails.ts#L343-L349,src/vs/editor/contrib/suggest/browser/suggestWidgetDetails.ts#L471-L492)、[src/vs/workbench/contrib/chat/browser/chatEditing/chatEditingCodeEditorIntegration.ts](src/vs/workbench/contrib/chat/browser/chatEditing/chatEditingCodeEditorIntegration.ts#L785-L825)）。

このように null が出るのは「まだ位置が不明」か「ウィジェット自身がレイアウトを握っている」ことを表すので、必要な場合には対象ウィジェットの `getPosition()` の戻り値とタイミングを追うのが次のステップです。
