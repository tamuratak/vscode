**同一コマンド `ls` で結果が出たり出なかったりする原因の調査**

- **出力取得の基本ロジック**
  - `RunInTerminal` はシェル統合の強さに応じて `Rich/Basical/NoneExecuteStrategy` を選び、コマンド実行前後に start/end マーカーを取ったり `CommandDetection` の終了イベント・アイドル判定を待って `output` を構築する。[src/vs/workbench/contrib/terminalContrib/chatAgentTools/browser/executeStrategy/basicExecuteStrategy.ts#L128-L192](src/vs/workbench/contrib/terminalContrib/chatAgentTools/browser/executeStrategy/basicExecuteStrategy.ts#L128-L192)
  - いずれの戦略でも失敗時は `xterm.getContentsAsText(start,end)` が例外になったり `finishedCommand.getOutput()` が `undefined` になって `output` が取れず、追加情報として「Failed to retrieve command output」が残る。また全戦略で代替バッファ (`less/vim` 等) が検出されると `didEnterAltBuffer` で出力収集を諦める。[src/vs/workbench/contrib/terminalContrib/chatAgentTools/browser/executeStrategy/richExecuteStrategy.ts#L82-L137](src/vs/workbench/contrib/terminalContrib/chatAgentTools/browser/executeStrategy/richExecuteStrategy.ts#L82-L137)

- **失敗がブレる要素**
  1. シェルがプロンプトを再描画したタイミングで start マーカーが dispose される (`setupRecreatingStartMarker` が再生成するが開始位置がずれる) と、`xterm.getContentsAsText` が失敗して `undefined` になる。タイミングによって成功/失敗が変わるため、同じ `ls` でも一部だけ取得できない。[src/vs/workbench/contrib/terminalContrib/chatAgentTools/browser/executeStrategy/strategyHelpers.ts#L1-L31](src/vs/workbench/contrib/terminalContrib/chatAgentTools/browser/executeStrategy/strategyHelpers.ts#L1-L31)
  2. SI が無い (`NoneExecuteStrategy`) 状態では `waitForIdleWithPromptHeuristics` により「プロンプトに見えるまで待つ」処理になるが、判定が長引いたり誤認してタイムアウトすると `OutputMonitor` が `Timeout`/`Cancelled` 状態になり、`pollingResult.output` に出力が残っていても `modelOutputEvalResponse` だけで完了したように見える。ユーザー入力待ちが入るとさらに結果が安定しない。[src/vs/workbench/contrib/terminalContrib/chatAgentTools/browser/executeStrategy/noneExecuteStrategy.ts#L81-L118](src/vs/workbench/contrib/terminalContrib/chatAgentTools/browser/executeStrategy/noneExecuteStrategy.ts#L81-L118)
  3. `OutputMonitor` 自体がプロンプトや選択肢を検出するとユーザー確認ループを起動するため、`ls` の直後に（例：`rm` の質問を含むような）出力があると、確認待ち状態でタイムアウトして結果取得アクションが飛ばされる。[src/vs/workbench/contrib/terminalContrib/chatAgentTools/browser/tools/monitoring/outputMonitor.ts#L176-L241](src/vs/workbench/contrib/terminalContrib/chatAgentTools/browser/tools/monitoring/outputMonitor.ts#L176-L241)
  4. `ls` の標準的な出力は `getOutput` 側で 16,000 文字に切り詰められるため、前回と同じ量の出力でも `MAX_OUTPUT_LENGTH` を超えた場合は末尾のみ返ってきて「出力なし」と見えるケースが出る。[src/vs/workbench/contrib/terminalContrib/chatAgentTools/browser/outputHelpers.ts#L12-L30](src/vs/workbench/contrib/terminalContrib/chatAgentTools/browser/outputHelpers.ts#L12-L30)

- **再現性の低さ**
  - ターミナルが代替バッファに入った瞬間や、`trackIdleOnPrompt` の完了タイミングが `sendText` → `ls` の完了をまたぐとコマンド検出イベントのペア（`A/B/C/D`）が乱れ、`CommandDetection.onCommandFinished` が違うコマンドに紐づいて `output` が空になる。これもタイミング次第で成功/失敗が分かれる。[src/vs/workbench/contrib/terminalContrib/chatAgentTools/browser/executeStrategy/basicExecuteStrategy.ts#L56-L142](src/vs/workbench/contrib/terminalContrib/chatAgentTools/browser/executeStrategy/basicExecuteStrategy.ts#L56-L142)

- **対策候補**
  1. ログ（`RunInTerminalTool#Basic`/`#Rich` の `Failed to fetch output via markers` や `didEnterAltBuffer`）を捕まえてタイミングのズレを特定。Alternate buffer が失敗の原因なら `isBackground=true` や `get_terminal_output` に切り替える。[src/vs/workbench/contrib/terminalContrib/chatAgentTools/browser/tools/runInTerminalTool.ts#L525-L798](src/vs/workbench/contrib/terminalContrib/chatAgentTools/browser/tools/runInTerminalTool.ts#L525-L798)
  2. SI が弱いセッションでは `TerminalChatAgentToolsSettingId.AutoReplyToPrompts` を ON にして `OutputMonitor` のユーザー確認プロンプトを自動化し、「入力待ちでタイムアウト」状態を減らす。[src/vs/workbench/contrib/terminalContrib/chatAgentTools/browser/tools/monitoring/outputMonitor.ts#L176-L241](src/vs/workbench/contrib/terminalContrib/chatAgentTools/browser/tools/monitoring/outputMonitor.ts#L176-L241)
  3. どうしても `setupRecreatingStartMarker` が動作しない場合は start/end マーカーではなく `BackgroundTerminalExecution` 経由で `getOutput` を直接取得する（代替バッファでも出力を取れるが、`didEnterAltBuffer` 判定が先に走るため制御が必要）。[src/vs/workbench/contrib/terminalContrib/chatAgentTools/browser/tools/runInTerminalTool.ts#L974-L991](src/vs/workbench/contrib/terminalContrib/chatAgentTools/browser/tools/runInTerminalTool.ts#L974-L991)
