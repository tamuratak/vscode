# Research Log
- 2026-02-11: `shouldPinPart` now unpins tool invocations that either wait for confirmation or carry `confirmationMessages`, so their confirmation UI must render outside the thinking part while `CollapsedToolsDisplayMode` is active; this boundary happens at [chatListRenderer.ts#L1418-L1494](src/vs/workbench/contrib/chat/browser/widget/chatListRenderer.ts#L1418-L1494) and may explain why confirmation widgets sometimes fail to appear in the main view.
- 2026-02-11: `renderToolInvocation` and the watcher set up by `setupConfirmationTransitionWatcher` move pinned tool DOM out of the thinking container once a confirmation state is reached, but the watcher only runs for streaming invocations that stay pinned; see [chatListRenderer.ts#L1845-L1963](src/vs/workbench/contrib/chat/browser/widget/chatListRenderer.ts#L1845-L1963).
- 2026-02-11: `ChatToolInvocationPart` re-renders the subpart on each state change, toggles the `has-confirmation` class, and chooses `ToolConfirmationSubPart` (or terminal/extension confirmations) when the tool reaches `WaitingForConfirmation`; refer to [chatToolInvocationPart.ts#L107-L244](src/vs/workbench/contrib/chat/browser/widget/chatContentParts/toolInvocationParts/chatToolInvocationPart.ts#L107-L244).
- 2026-02-11: `ToolConfirmationSubPart` requires a title in `confirmationMessages`, builds the message/disclaimer DOM, and exposes custom actions via `confirmationService`, so any missing data or rendering delay could leave the confirmation portion empty; see [chatToolConfirmationSubPart.ts#L66-L240](src/vs/workbench/contrib/chat/browser/widget/chatContentParts/toolInvocationParts/chatToolConfirmationSubPart.ts#L66-L240).

# Solution Plan
1. The diffing algorithm in `renderChatContentDiff` collapses identical `toolInvocation` entries based solely on `toolCallId` even though `shouldPinPart` flips to `false` as soon as a confirmation is pending ([chatListRenderer.ts#L1176-L1238](src/vs/workbench/contrib/chat/browser/widget/chatListRenderer.ts#L1176-L1238)). Because the thinking spinner lives in the same `renderedParts` slot, the tool is never rerendered outside the thinking area, leaving the confirmation card hidden while the thinking container stays collapsed.
2. The streaming watcher in `setupConfirmationTransitionWatcher` already knows when a pinned tool transitions to `WaitingForConfirmation`, so we can piggyback on that moment to move the DOM out; we just need to remember which tool calls are still pinned so that the diff step knows to recreate them outside thinking once `shouldPinPart` becomes `false` ([chatListRenderer.ts#L1850-L1963](src/vs/workbench/contrib/chat/browser/widget/chatListRenderer.ts#L1850-L1963)).
3. Implementation steps:
	- Track pinned tool invocations by storing their `toolCallId` when `renderToolInvocation` appends them to a `ChatThinkingContentPart` and clear the tracking when they unpin or are moved by the confirmation watcher.
	- In the `diff` pass, treat a previously pinned tool as changed whenever `shouldPinPart` now returns `false`, forcing a rerender of the standard `ChatToolInvocationPart` so `ToolConfirmationSubPart` renders in the main chat flow.
	- Keep `setupConfirmationTransitionWatcher` aligned with the new tracking so the DOM cleanup still happens when the tool becomes `WaitingForConfirmation` and the pinned flag is cleared.

# Next Steps
1. Trace a representative tool invocation that should pop a confirmation while `CollapsedToolsDisplayMode` keeps it inside a thinking part, and confirm whether `setupConfirmationTransitionWatcher` still runs once `shouldPinPart` returns false.
2. Reproduce the incorrect confirmation display by invoking a tool with `confirmationMessages`, inspect the DOM to see whether the `has-confirmation` class and confirmation subpart are rendered, and log the tool state transitions.
3. Verify that `ToolConfirmationSubPart` receives proper title/message/disclaimer payloads and that the fallback rendering path (string message vs. Markdown) cannot leave the user-facing text blank.

# Implementation
- Added a `_pinnedToolInvocations` set plus helper tracking methods so that `renderToolInvocation` marks the tool when it is appended to the thinking part and clears it once the pin condition ends; the `setupConfirmationTransitionWatcher` now also clears the track when it moves the confirmation DOM back into the main response ([chatListRenderer.ts#L1850-L1963](src/vs/workbench/contrib/chat/browser/widget/chatListRenderer.ts#L1850-L1963)).
- Updated the diff logic to treat a previously pinned tool as changed whenever `shouldPinPart` flips to `false`, forcing the `ChatToolInvocationPart` (and thus the `ToolConfirmationSubPart`) to rerender outside the thinking container ([chatListRenderer.ts#L1176-L1240](src/vs/workbench/contrib/chat/browser/widget/chatListRenderer.ts#L1176-L1240)).
